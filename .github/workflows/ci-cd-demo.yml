name: Mini CI/CD Demo

on:
  push:
    branches: [ main ]

jobs:
# ---------------------------------------------------
# 1Ô∏è‚É£ Build & Push Docker Image to ECR
# ---------------------------------------------------
  docker-build-push:
    name: Build & Push Docker Image to ECR
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2
      env:
         AWS_REGION: ${{ secrets.AWS_REGION }}
         AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
         AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}


    - name: Build, tag, and push Docker image
      env:
        ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:latest $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

# ---------------------------------------------------
# 2Ô∏è‚É£ Security Scan (Trivy)
# ---------------------------------------------------
  docker-security-scan:
    name: Scan Docker Image with Trivy
    runs-on: ubuntu-latest
    needs: docker-build-push

    steps:
    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2
      env:
         AWS_REGION: ${{ secrets.AWS_REGION }}
         AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
         AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    # Informational scan (never blocks)
    - name: Trivy scan (report)
      uses: aquasecurity/trivy-action@0.33.1
      with:
        image-ref: ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:latest
        severity: HIGH,CRITICAL
        ignore-unfixed: true
        format: table
        output: trivy-report.txt
        exit-code: 0

    # Upload report as artifact
    - name: Upload Trivy report
      uses: actions/upload-artifact@v4
      with:
         name: trivy-report
         path: trivy-report.txt

    # Gate scan (blocks on CRITICAL only)
    - name: Trivy scan (gate)
      uses: aquasecurity/trivy-action@0.33.1
      with:
       image-ref: ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:latest
       severity: CRITICAL
       ignore-unfixed: true
       exit-code: 1


# ---------------------------------------------------
# 3Ô∏è‚É£ Deploy to EC2 with Rollback
# ---------------------------------------------------
  deploy:
    name: Deploy Docker App to EC2
    runs-on: ubuntu-latest
    needs: docker-security-scan

    steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1
      env:
        AWS_REGION: ${{ secrets.AWS_REGION }}
        ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
        CONTAINER_NAME: mini-cicd-demo
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        envs: AWS_REGION,ECR_REGISTRY,ECR_REPOSITORY,CONTAINER_NAME
        script: |
          set -e  # exit immediately if any command fails

          echo "üöÄ Starting deployment"

          # Log into Amazon ECR
          echo "üîê Logging into Amazon ECR"
          aws ecr get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin $ECR_REGISTRY

          # Pull the latest image
          echo "üì¶ Pulling latest image from ECR"
          docker pull $ECR_REGISTRY/$ECR_REPOSITORY:latest

          # Save current container image digest for rollback
          if docker ps -a --format '{{.Names}}' | grep -Eq "^$CONTAINER_NAME\$"; then
            CURRENT_IMAGE=$(docker inspect --format='{{.Image}}' $CONTAINER_NAME)
            echo "üíæ Current image digest for rollback: $CURRENT_IMAGE"
          fi

          # Stop and remove old container
          echo "üõë Stopping old container (if exists)"
          docker stop $CONTAINER_NAME || true
          docker rm $CONTAINER_NAME || true

          # Run the new container
          echo "‚ñ∂Ô∏è Starting new container"
          docker run -d \
            --name $CONTAINER_NAME \
            -p 80:80 \
            --restart unless-stopped \
            $ECR_REGISTRY/$ECR_REPOSITORY:latest

          # Verify container is running
          NEW_CONTAINER=$(docker ps --filter "name=$CONTAINER_NAME" --format '{{.ID}}')
          if [ -z "$NEW_CONTAINER" ]; then
            echo "‚ùå Deployment failed, rolling back..."

            if [ -n "$CURRENT_IMAGE" ]; then
              docker run -d \
                --name $CONTAINER_NAME \
                -p 80:80 \
                --restart unless-stopped \
                $CURRENT_IMAGE
              echo "‚úÖ Rollback successful"
            else
              echo "‚ö† No previous container found to rollback"
            fi
            exit 1
          fi

          echo "‚úÖ Deployment completed successfully"